(function($) {
    const version = "0.8.0";
    $.fn.bootstrapModal = function(options) {
        var _init = (options) => {
            if (options == undefined) return this;
            var globalDefaults = {
                debug: false,
                title: null,
                closeButton: true,
                backdropClose: true,
                footer: true,
                show: false,
                class: "",
                content: null,
                size: "medium",
                buttons: [{
                    type: "button",
                    class: "btn red btn-outline",
                    callback: this.close,
                    text: "Cancel"
                }, {
                    type: "button",
                    class: "btn blue",
                    callback: this.ok,
                    text: "OK"
                }]
            };
            var globalSettings = $.extend({}, globalDefaults, options);
            $(this).each((i, el) => {
                var $el = $(el);
                $el.bootstrapModal = this;
                var defaults = {
                    _random: Math.random().toString(36).substr(2)
                }
                var settings = $.extend({}, globalSettings, defaults);
                if (settings.content == null) {
                    var content = $el.html();
                    settings.content = content;
                    $el.html('');
                }
                settings.el = el;
                el.bootstrapModal_settings = settings;
                if (settings.debug) console.debug('[bootstrapModal](debug): Init!');
                _loadHTML();
                if (settings.debug) console.debug('[bootstrapModal](debug) Component:', {
                    "el": el,
                    "bootstrapModal": this
                });
            });
            return this;
        }
        var _loadHTML = () => {
            $(this).each((i, el) => {
                var settings = this.getSettings(i);
                var modal = $('<div class="' + settings.class + '" id="' + settings._random + '-modal" ' + (settings.show ? '' : ' style="display:none"') + '><div class="modal" role="dialog"></div></div>');
                var modalContent = $('<div class="modal-content"></div>');
                var modalHeader = $('<div class="modal-header"></div>');
                var closeButtonsCnt = 0
                if (settings.content != null) closeButtonsCnt = $('.close', $('<div>' + settings.content + '</div>')).length;
                if (settings.closeButton !== false) {
                    if (settings.closeButton === true && closeButtonsCnt == 0) {
                        modalHeader.append('<a type="button" class="close">x</a>');
                        $('.close', modalHeader).click(() => {
                            this.close()
                        });
                    }
                }
                if (settings.title != null) {
                    modalHeader.append('<h4 class="modal-title">' + settings.title + '</h4>');
                }
                var modalFooter = $('<div v-if="footer" class="modal-footer"></div>');
                settings.buttons.forEach((val, i) => {
                    var btn = $('<button type="' + val.type + '" class="' + val.class + '">' + val.text + '</button>');
                    btn.click(val.callback);
                    modalFooter.append(btn);
                });
                if (settings.closeButton !== false || settings.title) modalContent.append(modalHeader)
                modalContent.append($('<div class="modal-body">' + settings.content + '</div>'));
                if (settings.footer) {
                    modalContent.append(modalFooter);
                }
                $('.close', modalContent).click(() => {
                    this.close()
                });
                $('.modal', modal).append($('<div class="modal-dialog"></div>').append(modalContent));
                $(settings.el).prepend(modal);
            });
        }
        this.setContent = (content, settings) => {
            if (settings == undefined) {
                $(this).each((i, el) => {
                    var settings = this.getSettings(i);
                    return this.setContent(content, settings);
                });
            } else {
                $("#" + settings._random + "-modal .modal-body", settings.el).html('').append(content);
            }
            return this;
        }
        this.getContent = () => {
            var settings = this.getSettings(0);
            return $('.modal-content', '#' + settings._random + '-modal').html();
        }
        this.show = (settings) => {
            if (settings == undefined) {
                $(this).each((i, el) => {
                    var settings = this.getSettings(i);
                    return this.show(settings);
                });
            } else {
                var modalBackdrop = $('<div id="' + settings._random + '-backdrop" class="modal-backdrop in"></div>');
                if (settings.backdropClose) modalBackdrop.click(() => {
                    this.close()
                });
                $('body').append(modalBackdrop);
                $('body').addClass('modal-open');
                $('#' + settings._random + '-modal', settings.el).show();
            }
            return this;
        }
        this.close = (settings) => {
            if (settings == undefined) {
                $(this).each((i, el) => {
                    var settings = this.getSettings(i);
                    return this.close(settings);
                });
            } else {
                $('body').removeClass('modal-open');
                $('#' + settings._random + '-backdrop').remove();
                $('#' + settings._random + '-modal').hide();
            }
            return this;
        }
        this.getSettings = (i) => {
            return this[i].bootstrapModal_settings;
        }
        return _init(options);
    };
}(jQuery));